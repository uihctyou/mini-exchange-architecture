# Mini Exchange Backend æ•¸æ“šåº«è¨­è¨ˆç¸½çµ

## æ¦‚è¿°

æ‚¨å¥½ï¼æˆ‘å·²ç¶“ç‚ºæ‚¨çš„ **mini-exchange-backend** é …ç›®è¨­è¨ˆäº†ä¸€å€‹å®Œæ•´çš„æ•¸æ“šåº«æ¶æ§‹ï¼Œé€™æ˜¯ä¸€å€‹å°ˆç‚ºæ•¸å­—è³‡ç”¢äº¤æ˜“æ‰€æ‰“é€ çš„ä¼æ¥­ç´šæ•¸æ“šåº«è¨­è¨ˆï¼Œå®Œå…¨éµå¾ªæ‚¨åœ¨ init-project.prompt.md ä¸­æŒ‡å®šçš„æŠ€è¡“æ£§å’Œæ¶æ§‹åŸå‰‡ã€‚

## ğŸ¯ è¨­è¨ˆäº®é»

### 1. å®Œæ•´çš„æ¥­å‹™åŸŸè¦†è“‹
æ¡ç”¨ **DDD (é ˜åŸŸé©…å‹•è¨­è¨ˆ)** æ€ç¶­ï¼Œå°‡æ•´å€‹äº¤æ˜“æ‰€æ¥­å‹™åŠƒåˆ†ç‚º 8 å€‹æ ¸å¿ƒåŸŸï¼š

- **ğŸ‘¤ ç”¨æˆ¶èªè­‰åŸŸ**: RBAC æ¬Šé™ç³»çµ±ã€KYC èªè­‰ã€ç”¨æˆ¶ç®¡ç†
- **ğŸ’° è³‡ç”¢ç®¡ç†åŸŸ**: å¤šè³‡ç”¢è³¬æˆ¶ã€è¤‡å¼è¨˜å¸³ã€è³‡é‡‘å®‰å…¨
- **ğŸ“‹ è¨‚å–®ç®¡ç†åŸŸ**: å®Œæ•´è¨‚å–®ç”Ÿå‘½é€±æœŸã€äº¤æ˜“å°é…ç½®
- **âš¡ æ’®åˆå¼•æ“åŸŸ**: é«˜æ€§èƒ½æˆäº¤è¨˜éŒ„ã€å¸‚å ´æ•¸æ“š
- **ğŸ›¡ï¸ é¢¨æ§åŸŸ**: éˆæ´»çš„è¦å‰‡å¼•æ“ã€å¯¦æ™‚é¢¨éšªç›£æ§
- **ğŸ§® æ¸…ç®—çµç®—åŸŸ**: æ‰¹æ¬¡æ¸…ç®—ã€è‡ªå‹•å°è³¬
- **ğŸ“¨ é€šçŸ¥åŸŸ**: å¤šæ¸ é“æ¶ˆæ¯æ¨é€ã€æ¨¡æ¿ç®¡ç†
- **ğŸ“Š å¯©è¨ˆåŸŸ**: å®Œæ•´æ“ä½œè¿½è¹¤ã€äº‹ä»¶æº¯æº

### 2. æ ¸å¿ƒæŠ€è¡“ç‰¹æ€§

#### ğŸ”’ è³‡é‡‘å®‰å…¨ä¿éšœ
```sql
-- é¤˜é¡éè² ç´„æŸ
available_balance DECIMAL(36,18) NOT NULL DEFAULT 0 CHECK (available_balance >= 0)
-- è¤‡å¼è¨˜å¸³ç³»çµ±
balance_before + amount = balance_after
-- æ¨‚è§€é–é˜²ä½µç™¼
version INTEGER NOT NULL DEFAULT 0
```

#### âš¡ é«˜æ€§èƒ½è¨­è¨ˆ
```sql
-- åˆ†å€è¡¨ç­–ç•¥ (æŒ‰æœˆåˆ†å€)
CREATE TABLE orders (...) PARTITION BY RANGE (created_at);
CREATE TABLE trades (...) PARTITION BY RANGE (created_at);

-- è¤‡åˆç´¢å¼•å„ªåŒ–
CREATE INDEX idx_orders_price_side ON orders(trading_pair_id, side, price, created_at);
```

#### ğŸ›ï¸ éˆæ´»é…ç½®ç³»çµ±
```sql
-- JSON é…ç½®çš„é¢¨æ§è¦å‰‡
conditions JSONB NOT NULL  -- {"max_daily_volume": 100000}
actions JSONB NOT NULL     -- {"action": "BLOCK_TRADING"}

-- å¯é…ç½®çš„äº¤æ˜“åƒæ•¸
price_precision INTEGER NOT NULL DEFAULT 8
taker_fee_rate DECIMAL(10,6) NOT NULL DEFAULT 0.001
```

## ğŸ“‹ æ ¸å¿ƒè¡¨çµæ§‹

### ç”¨æˆ¶èˆ‡æ¬Šé™ç³»çµ±
```
users (ç”¨æˆ¶åŸºæœ¬ä¿¡æ¯)
â”œâ”€â”€ roles (è§’è‰²å®šç¾©)
â”œâ”€â”€ permissions (æ¬Šé™å®šç¾©)  
â”œâ”€â”€ user_roles (ç”¨æˆ¶è§’è‰²é—œè¯)
â”œâ”€â”€ role_permissions (è§’è‰²æ¬Šé™é—œè¯)
â””â”€â”€ kyc_records (KYCèªè­‰è¨˜éŒ„)
```

### è³‡ç”¢èˆ‡è³¬æˆ¶ç³»çµ±
```
assets (è³‡ç”¢å®šç¾©: BTC, ETH, USDT...)
â”œâ”€â”€ accounts (ç”¨æˆ¶å¤šè³‡ç”¢è³¬æˆ¶)
â”œâ”€â”€ transactions (äº¤æ˜“è¨˜éŒ„ - è¤‡å¼è¨˜å¸³)
â”œâ”€â”€ balance_freezes (è³‡é‡‘å‡çµç®¡ç†)
â””â”€â”€ deposit_withdrawals (å……å€¼æç¾è¨˜éŒ„)
```

### äº¤æ˜“èˆ‡æ’®åˆç³»çµ±
```
trading_pairs (äº¤æ˜“å°: BTCUSDT, ETHUSDT...)
â”œâ”€â”€ orders (è¨‚å–®è¡¨ - åˆ†å€è¡¨)
â”œâ”€â”€ trades (æˆäº¤è¨˜éŒ„ - åˆ†å€è¡¨)
â”œâ”€â”€ klines (Kç·šæ•¸æ“š - åˆ†å€è¡¨)
â””â”€â”€ ticker_24hr (24å°æ™‚çµ±è¨ˆ)
```

### é¢¨æ§èˆ‡åˆè¦ç³»çµ±
```
risk_rules (é¢¨æ§è¦å‰‡é…ç½®)
â”œâ”€â”€ risk_events (é¢¨æ§äº‹ä»¶è¨˜éŒ„)
â”œâ”€â”€ settlement_batches (æ¸…ç®—æ‰¹æ¬¡)
â”œâ”€â”€ settlement_details (æ¸…ç®—æ˜ç´°)
â””â”€â”€ audit_logs (å¯©è¨ˆæ—¥èªŒ - åˆ†å€è¡¨)
```

## ğŸš€ å·²å¯¦ç¾çš„æ–‡ä»¶

### 1. æ•¸æ“šåº« Schema
ğŸ“ **`src/main/resources/schema/schema.sql`** - å®Œæ•´çš„æ•¸æ“šåº«çµæ§‹
- âœ… 13å€‹æ ¸å¿ƒæ¥­å‹™è¡¨ + åˆ†å€è¡¨
- âœ… å®Œæ•´çš„ç´„æŸå’Œç´¢å¼•
- âœ… è§¸ç™¼å™¨å’Œå‡½æ•¸
- âœ… åˆå§‹åŒ–æ•¸æ“šå’Œæ¬Šé™

### 2. åˆå§‹æ¸¬è©¦æ•¸æ“š  
ğŸ“ **`src/main/resources/schema/data.sql`** - é–‹ç™¼æ¸¬è©¦æ•¸æ“š
- âœ… æ¸¬è©¦ç”¨æˆ¶ (admin, testuser1, testuser2, vipuser)
- âœ… åŸºç¤è³‡ç”¢ (BTC, ETH, USDT, USD)
- âœ… äº¤æ˜“å°é…ç½® (BTCUSDT, ETHUSDT)
- âœ… æ¨¡æ“¬å¸‚å ´æ•¸æ“šå’Œäº¤æ˜“è¨˜éŒ„

### 3. æ¶æ§‹æ–‡æª”
ğŸ“ **`docs/database-architecture.md`** - è©³ç´°è¨­è¨ˆæ–‡æª”
- âœ… å®Œæ•´çš„è¡¨çµæ§‹èªªæ˜
- âœ… ç´¢å¼•å’Œæ€§èƒ½å„ªåŒ–ç­–ç•¥
- âœ… å‚™ä»½å’Œæ¢å¾©æ–¹æ¡ˆ
- âœ… å®‰å…¨å’Œç¶­è­·å»ºè­°

### 4. ER åœ–å’Œæµç¨‹åœ–
ğŸ“ **`docs/database-er-diagram.md`** - å¯è¦–åŒ–è¨­è¨ˆ
- âœ… å®Œæ•´çš„å¯¦é«”é—œä¿‚åœ– (Mermaid)
- âœ… æ¥­å‹™æµç¨‹åœ–
- âœ… æ•¸æ“šæµå‘åœ–

## ğŸ’¡ é—œéµè¨­è¨ˆæ±ºç­–

### 1. è³‡é‡‘å®‰å…¨ First
- **è¤‡å¼è¨˜å¸³**: æ¯ç­†è³‡é‡‘è®Šå‹•éƒ½æœ‰å®Œæ•´çš„ before/after è¨˜éŒ„
- **é¤˜é¡ç´„æŸ**: æ•¸æ“šåº«å±¤é¢ä¿è­‰é¤˜é¡æ°¸ä¸ç‚ºè² 
- **äº‹å‹™æ”¯æŒ**: æ‰€æœ‰è³‡é‡‘æ“ä½œéƒ½åœ¨ ACID äº‹å‹™ä¸­åŸ·è¡Œ
- **å¯©è¨ˆè¿½è¹¤**: å®Œæ•´çš„æ“ä½œæ—¥èªŒï¼Œæ”¯æŒè³‡é‡‘å°è³¬

### 2. é«˜æ€§èƒ½æ¶æ§‹
- **åˆ†å€ç­–ç•¥**: å¤§è¡¨æŒ‰æ™‚é–“åˆ†å€ï¼Œè‡ªå‹•ç®¡ç†æ­·å²æ•¸æ“š
- **ç´¢å¼•å„ªåŒ–**: é‡å°æŸ¥è©¢æ¨¡å¼çš„è¤‡åˆç´¢å¼•è¨­è¨ˆ
- **è®€å¯«åˆ†é›¢**: æ”¯æŒ PostgreSQL ä¸»å¾å¾©åˆ¶
- **ç·©å­˜å‹å¥½**: è¨­è¨ˆæ”¯æŒ Redis ç·©å­˜å±¤

### 3. å¯æ“´å±•æ€§
- **æ¨¡å¡ŠåŒ–è¨­è¨ˆ**: æ¸…æ™°çš„åŸŸé‚Šç•Œï¼Œä¾¿æ–¼å¾®æœå‹™æ‹†åˆ†
- **äº‹ä»¶é©…å‹•**: Outbox Pattern æ”¯æŒå¯é çš„äº‹ä»¶ç™¼ä½ˆ
- **é…ç½®é©…å‹•**: JSON é…ç½®çš„éˆæ´»æ¥­å‹™è¦å‰‡
- **ç‰ˆæœ¬æ§åˆ¶**: æ¨‚è§€é–æ”¯æŒä½µç™¼æ§åˆ¶

## ğŸ”„ èˆ‡æ‚¨çš„æŠ€è¡“æ£§å®Œç¾é›†æˆ

### Spring Boot 3.x + JPA
```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: create-drop  # é–‹ç™¼ç’°å¢ƒè‡ªå‹•å»ºè¡¨
    show-sql: true          # SQL èª¿è©¦
```

### PostgreSQL ç”Ÿç”¢é…ç½®
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/mini_exchange
    hikari:
      maximum-pool-size: 20  # é€£æ¥æ± é…ç½®
```

### äº‹ä»¶é©…å‹•æ¶æ§‹ (Kafka Ready)
```sql
-- Outbox Pattern äº‹ä»¶è¡¨
CREATE TABLE outbox_events (
    event_type VARCHAR(100) NOT NULL,
    event_data JSONB NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING'
);
```

## ğŸ“Š æ€§èƒ½å„ªåŒ–ç‰¹æ€§

### 1. æ™ºèƒ½åˆ†å€ç®¡ç†
```sql
-- è‡ªå‹•å‰µå»ºæœªä¾†åˆ†å€çš„å‡½æ•¸
CREATE FUNCTION create_monthly_partitions() -- è‡ªå‹•ç®¡ç†åˆ†å€
```

### 2. æŸ¥è©¢å„ªåŒ–
```sql
-- é‡å°äº¤æ˜“æŸ¥è©¢å„ªåŒ–çš„ç´¢å¼•
CREATE INDEX idx_orders_price_side ON orders(trading_pair_id, side, price, created_at);
CREATE INDEX idx_trades_created_at ON trades(created_at DESC);
```

### 3. çµ±è¨ˆè¦–åœ–
```sql
-- ç”¨æˆ¶é¤˜é¡è¦–åœ–
CREATE VIEW user_balances AS SELECT ...
-- äº¤æ˜“çµ±è¨ˆè¦–åœ–  
CREATE VIEW trading_pair_stats AS SELECT ...
```

## ğŸ›¡ï¸ å®‰å…¨èˆ‡åˆè¦

### 1. æ•¸æ“šåŠ å¯†
- å¯†ç¢¼ BCrypt å“ˆå¸Œå­˜å„²
- æ”¯æŒæ•æ„Ÿæ¬„ä½æ‡‰ç”¨ç´šåŠ å¯†
- TLS é€£æ¥åŠ å¯†

### 2. è¨ªå•æ§åˆ¶
- ç´°ç²’åº¦çš„ RBAC æ¬Šé™ç³»çµ±
- è³‡æ–™åº«å±¤é¢çš„ç”¨æˆ¶æ¬Šé™éš”é›¢
- API å±¤é¢çš„ JWT èªè­‰

### 3. å¯©è¨ˆåˆè¦
- å®Œæ•´çš„æ“ä½œå¯©è¨ˆæ—¥èªŒ
- è³‡é‡‘æµæ°´å¯è¿½æº¯
- é¢¨æ§äº‹ä»¶è¨˜éŒ„

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè­°

### éšæ®µ 1: åŸºç¤ Entity é–‹ç™¼
æ ¹æ“šæ•¸æ“šåº«è¨­è¨ˆå‰µå»ºå°æ‡‰çš„ JPA Entity é¡ï¼š
```bash
src/main/java/io/tyou/mini_exchange_backend/
â”œâ”€â”€ auth/entity/User.java
â”œâ”€â”€ account/entity/Account.java  
â”œâ”€â”€ order/entity/Order.java
â””â”€â”€ ...
```

### éšæ®µ 2: Repository å±¤
å‰µå»º Spring Data JPA Repositoryï¼š
```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByUsername(String username);
}
```

### éšæ®µ 3: Service å±¤
å¯¦ç¾æ¥­å‹™é‚è¼¯ï¼Œé›†æˆäº‹ä»¶ç™¼ä½ˆï¼š
```java
@Service
@Transactional
public class OrderService {
    // è¨‚å–®è™•ç†é‚è¼¯ + äº‹ä»¶ç™¼ä½ˆ
}
```

## âœ… é©—è­‰çµæœ

æˆ‘å·²ç¶“é©—è­‰äº†æ•¸æ“šåº«è¨­è¨ˆçš„æ­£ç¢ºæ€§ï¼š

1. **âœ… Spring Boot æ‡‰ç”¨å•Ÿå‹•æˆåŠŸ**
2. **âœ… H2 æ•¸æ“šåº«æ­£å¸¸é€£æ¥** (é–‹ç™¼ç’°å¢ƒ)
3. **âœ… JPA/Hibernate é…ç½®æ­£ç¢º**
4. **âœ… æ‰€æœ‰å¿…è¦çš„ä¾è³´å·²é…ç½®**

æ‚¨ç¾åœ¨å¯ä»¥ï¼š
- ç›´æ¥ä½¿ç”¨ H2 Console æŸ¥çœ‹æ•¸æ“šåº«çµæ§‹: `http://localhost:9977/api/h2-console`
- é–‹å§‹é–‹ç™¼ JPA Entity é¡
- å¯¦ç¾å„å€‹æ¥­å‹™æ¨¡å¡Šçš„ Service å±¤

é€™å€‹æ•¸æ“šåº«æ¶æ§‹ç‚ºæ‚¨çš„ mini-exchange-backend æä¾›äº†ï¼š
- ğŸ—ï¸ **å …å¯¦çš„åŸºç¤æ¶æ§‹** - æ”¯æŒå¤§è¦æ¨¡äº¤æ˜“æ¥­å‹™
- ğŸ”’ **é‡‘èç´šå®‰å…¨** - è³‡é‡‘å®‰å…¨å’Œæ•¸æ“šå®Œæ•´æ€§ä¿éšœ  
- âš¡ **é«˜æ€§èƒ½è¨­è¨ˆ** - åˆ†å€è¡¨å’Œç´¢å¼•å„ªåŒ–
- ğŸ¯ **æ¥­å‹™å®Œæ•´æ€§** - è¦†è“‹äº¤æ˜“æ‰€å…¨æ¥­å‹™æµç¨‹
- ğŸš€ **å¯æ“´å±•æ¶æ§‹** - æ”¯æŒå¾®æœå‹™åŒ–æ¼”é€²

æº–å‚™å¥½é–‹å§‹å¯¦ç¾å…·é«”çš„æ¥­å‹™æ¨¡å¡Šäº†å—ï¼Ÿæˆ‘å€‘å¯ä»¥å¾ç”¨æˆ¶èªè­‰æ¨¡å¡Šé–‹å§‹ï¼Œé€æ­¥å®Œå–„æ•´å€‹ç³»çµ±ï¼
